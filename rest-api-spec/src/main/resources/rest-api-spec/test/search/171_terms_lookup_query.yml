---
"Terms Query - Lookup by Query":
  - skip:
      version: " - 3.1.99"
      reason: All tests in this file require features added in 3.2.0 or later (terms query lookup by query).
  # Match all docs in lookup_index with group=g1, use their 'followers' as terms
  - do:
      search:
        rest_total_hits_as_int: true
        index: main_index
        body:
          query:
            terms:
              user:
                index: lookup_index
                path: followers
                query:
                  term:
                    group: "g1"
  - match: { hits.total: 4 } # foo (u1), bar (u2), baz (u3), foo (u5)

  # Query returns docs, but some have missing/null/empty field
  - do:
      search:
        rest_total_hits_as_int: true
        index: main_index
        body:
          query:
            terms:
              user:
                index: lookup_index
                path: followers
                query:
                  terms:
                    tag: ["a", "c", "f"]
  - match: { hits.total: 3 } # foo (u1), bar (u2), foo (u5)

  # Query returns docs but field is always empty list
  - do:
      search:
        rest_total_hits_as_int: true
        index: main_index
        body:
          query:
            terms:
              user:
                index: lookup_index
                path: followers
                query:
                  term:
                    tag: "d"
  - match: { hits.total: 0 } # No terms found

  # Query returns docs but field is scalar, not array
  - do:
      search:
        rest_total_hits_as_int: true
        index: main_index
        body:
          query:
            terms:
              user:
                index: lookup_index
                path: followers
                query:
                  term:
                    tag: "e"
  - match: { hits.total: 1 } # Only user baz (from doc 5: followers="baz")

  # Query returns no docs
  - do:
      search:
        rest_total_hits_as_int: true
        index: main_index
        body:
          query:
            terms:
              user:
                index: lookup_index
                path: followers
                query:
                  term:
                    tag: "zzz"
  - match: { hits.total: 0 }

  # Query returns docs, some with missing field, some with lists, some with nulls
  - do:
      search:
        rest_total_hits_as_int: true
        index: main_index
        body:
          query:
            terms:
              user:
                index: lookup_index
                path: followers
                query:
                  terms:
                    tag: ["a", "b", "c", "d", "e", "f"]
  - match: { hits.total: 4 } # foo (u1), bar (u2), baz (u3), foo (u5)

  # Duplicates across docs should be deduplicated (foo appears in 2 docs)
  - do:
      search:
        rest_total_hits_as_int: true
        index: main_index
        body:
          query:
            terms:
              user:
                index: lookup_index
                path: followers
                query:
                  terms:
                    tag: ["a", "b"]
  - match: { hits.total: 4 } # foo (u1), bar (u2), baz (u3), foo (u5)

  # Query returns docs but none have the field specified.
  - do:
      search:
        rest_total_hits_as_int: true
        index: main_index
        body:
          query:
            terms:
              user:
                index: lookup_index
                path: not_a_field
                query:
                  match_all: {}
  - match: { hits.total: 0 }
