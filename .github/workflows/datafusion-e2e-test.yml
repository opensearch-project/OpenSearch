name: DataFusion E2E Integration Test

on:
  pull_request:
    branches:
      - feature/datafusion
  push:
    branches:
      - feature/datafusion
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      RUSTFLAGS: "-A unused_variables -A unused_mut"

    steps:
      - name: Checkout OpenSearch
        uses: actions/checkout@v4
        with:
          path: OpenSearch

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: rustfmt

      - name: Install Protocol Buffers
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler

      - name: Install Protocol Buffers
        if: runner.os == 'macOS'
        run: brew install protobuf

      - name: Install Protocol Buffers
        if: runner.os == 'Windows'
        run: choco install protoc

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Publish OpenSearch to Maven Local
        working-directory: OpenSearch
        run: ./gradlew publishToMavenLocal -x test -PrustDebug=true

      - name: Checkout SQL Plugin
        uses: actions/checkout@v4
        with:
          repository: vinaykpud/sql
          ref: feature/substrait-plan
          path: opensearch-sql

      - name: Publish SQL Plugin to Maven Local
        working-directory: opensearch-sql
        run: ./gradlew publishToMavenLocal -x test

      - name: Run DataFusionReaderManager Tests
        working-directory: OpenSearch
        run: ./gradlew :plugins:engine-datafusion:test --tests "org.opensearch.datafusion.DataFusionReaderManagerTests"

      - name: Run OpenSearch with DataFusion Plugin
        working-directory: OpenSearch
        run: |
          ./gradlew run \
            --preserve-data \
            -PremotePlugins="['org.opensearch.plugin:opensearch-job-scheduler:3.3.0.0-SNAPSHOT', 'org.opensearch.plugin:opensearch-sql-plugin:3.3.0.0-SNAPSHOT']" \
            -PinstalledPlugins="['engine-datafusion']" &

          # Wait for OpenSearch to start
          timeout 300 bash -c 'until curl -s http://localhost:9200; do sleep 5; done'

      - name: Run E2E Tests
        run: |
          # Create index
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X PUT 'http://localhost:9200/index-7' \
            -H 'Content-Type: application/json' \
            -d '{
              "settings": {
                "number_of_shards": 1,
                "number_of_replicas": 0,
                "refresh_interval": -1
              },
              "mappings": {
                "properties": {
                  "id": {"type": "keyword"},
                  "name": {"type": "keyword"},
                  "age": {"type": "integer"},
                  "salary": {"type": "long"},
                  "score": {"type": "double"},
                  "active": {"type": "boolean"},
                  "created_date": {"type": "date"}
                }
              }
            }')
          if [ "$HTTP_CODE" != "200" ]; then
            echo "Failed to create index. HTTP status: $HTTP_CODE"
            exit 1
          fi

          # Index documents
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST 'http://localhost:9200/_bulk' \
            -H 'Content-Type: application/json' \
            -d '{"index":{"_index":"index-7"}}
                {"id":"1","name":"Alice","age":30,"salary":75000,"score":95.5,"active":true,"created_date":"2024-01-15"}
                {"index":{"_index":"index-7"}}
                {"id":"2","name":"Bob","age":25,"salary":60000,"score":88.3,"active":true,"created_date":"2024-02-20"}
                {"index":{"_index":"index-7"}}
                {"id":"3","name":"Charlie","age":35,"salary":90000,"score":92.7,"active":false,"created_date":"2024-03-10"}
                {"index":{"_index":"index-7"}}
                {"id":"4","name":"Diana","age":28,"salary":70000,"score":89.1,"active":true,"created_date":"2024-04-05"}
                {"index":{"_index":"index-7"}}
                {"id":"5","name":"Bob","age":30,"salary":55000,"score":81.1,"active":true,"created_date":"2024-04-05"}
                {"index":{"_index":"index-7"}}
                {"id":"6","name":"Diana","age":35,"salary":65000,"score":71.1,"active":true,"created_date":"2024-02-05"}
          ')
          if [ "$HTTP_CODE" != "200" ]; then
            echo "Failed to index documents. HTTP status: $HTTP_CODE"
            exit 1
          fi

          # Refresh index
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST 'localhost:9200/index-7/_refresh')
          if [ "$HTTP_CODE" != "200" ]; then
            echo "Failed to refresh index. HTTP status: $HTTP_CODE"
            exit 1
          fi

          # Query 1: stats with min, max, avg
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST 'http://localhost:9200/_plugins/_ppl' \
            -H 'Content-Type: application/json' \
            -d '{"query": "source=index-7 | stats count(), min(age) as min, max(age) as max, avg(age) as avg"}')
          if [ "$HTTP_CODE" != "200" ]; then
            echo "Query 1 failed. HTTP status: $HTTP_CODE"
            exit 1
          fi

          # Query 2: count by name with sort
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST 'http://localhost:9200/_plugins/_ppl' \
            -H 'Content-Type: application/json' \
            -d '{"query": "source=index-7 | stats count() as c by name | sort c"}')
          if [ "$HTTP_CODE" != "200" ]; then
            echo "Query 2 failed. HTTP status: $HTTP_CODE"
            exit 1
          fi

          # Query 3: count and sum by name with sort
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST 'http://localhost:9200/_plugins/_ppl' \
            -H 'Content-Type: application/json' \
            -d '{"query": "source=index-7 | stats count(), sum(age) as c by name | sort c"}')
          if [ "$HTTP_CODE" != "200" ]; then
            echo "Query 3 failed. HTTP status: $HTTP_CODE"
            exit 1
          fi

          # Query 4: where clause with stats
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST 'http://localhost:9200/_plugins/_ppl' \
            -H 'Content-Type: application/json' \
            -d '{"query": "source=index-7 | where name = \"Bob\" | stats sum(age)"}')
          if [ "$HTTP_CODE" != "200" ]; then
            echo "Query 4 failed. HTTP status: $HTTP_CODE"
            exit 1
          fi

          # Query 5: sum by name sorted by sum
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST 'http://localhost:9200/_plugins/_ppl' \
            -H 'Content-Type: application/json' \
            -d '{"query": "source=index-7 | stats sum(age) as s by name | sort s"}')
          if [ "$HTTP_CODE" != "200" ]; then
            echo "Query 5 failed. HTTP status: $HTTP_CODE"
            exit 1
          fi

          # Query 6: sum by name sorted by name
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST 'http://localhost:9200/_plugins/_ppl' \
            -H 'Content-Type: application/json' \
            -d '{"query": "source=index-7 | stats sum(age) as s by name | sort name"}')
          if [ "$HTTP_CODE" != "200" ]; then
            echo "Query 6 failed. HTTP status: $HTTP_CODE"
            exit 1
          fi

          # Query 7: count by name
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST 'http://localhost:9200/_plugins/_ppl' \
            -H 'Content-Type: application/json' \
            -d '{"query": "source=index-7 | stats count() as c by name"}')
          if [ "$HTTP_CODE" != "200" ]; then
            echo "Query 7 failed. HTTP status: $HTTP_CODE"
            exit 1
          fi

          echo "All E2E tests passed successfully!"
