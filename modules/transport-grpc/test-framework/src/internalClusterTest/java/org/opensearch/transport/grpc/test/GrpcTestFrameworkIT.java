/*
 * SPDX-License-Identifier: Apache-2.0
 *
 * The OpenSearch Contributors require contributions made to
 * this file be licensed under the Apache-2.0 license or a
 * compatible open source license.
 */

package org.opensearch.transport.grpc.test;

import io.grpc.ManagedChannel;
import org.opensearch.transport.grpc.ssl.NettyGrpcClient;

import java.util.Arrays;
import java.util.List;

/**
 * Integration tests for the gRPC test framework utility methods.
 */
public class GrpcTestFrameworkIT extends GrpcOpenSearchIntegTestCase {

    public void testDoBulkWithAutoGeneratedDocs() throws Exception {
        String indexName = "test-bulk-auto-index";
        try (NettyGrpcClient client = createGrpcClient()) {
            ManagedChannel channel = client.getChannel();
            GrpcTestBulkResponse response = doBulk(channel, indexName, 5);
            assertEquals("Should have 5 documents", 5, response.getCount());
            assertEquals("Should have no errors", 0, response.getErrors());
        }
    }

    public void testDoBulkWithProvidedDocs() throws Exception {
        String indexName = "test-bulk-provided-index";
        List<String> docs = List.of(
            "{\"title\": \"Doc 1\", \"content\": \"Content 1\"}",
            "{\"title\": \"Doc 2\", \"content\": \"Content 2\"}"
        );
        try (NettyGrpcClient client = createGrpcClient()) {
            ManagedChannel channel = client.getChannel();
            GrpcTestBulkResponse response = doBulk(channel, indexName, docs);
            assertEquals("Should have 2 documents", 2, response.getCount());
            assertEquals("Should have no errors", 0, response.getErrors());
        }
    }

    public void testDoMatchAll() throws Exception {
        String indexName = "test-search-index";
        try (NettyGrpcClient client = createGrpcClient()) {
            ManagedChannel channel = client.getChannel();
            List<String> docs = Arrays.asList(
                "{\"field\": \"doc 0 body\"}",
                "{\"field\": \"doc 1 body\"}"
            );
            doBulk(channel, indexName, docs);
            GrpcTestSearchResponse response = doMatchAll(channel, indexName, 10);
            assertTrue("Should return results", response.getTotalCount() >= 2);
            assertNotNull("Document source should not be null", response.getDocumentSource(0));
        }
    }
}
