/*
 * SPDX-License-Identifier: Apache-2.0
 *
 * The OpenSearch Contributors require contributions made to
 * this file be licensed under the Apache-2.0 license or a
 * compatible open source license.
 */

apply plugin: 'opensearch.build'
apply plugin: 'application'

assemble.enabled = false

application {
  mainClass = 'org.openjdk.jmh.Main'
}

base {
  archivesName = 'parquet-data-format-benchmarks'
}

test.enabled = false

dependencies {
  // Dependency on parent parquet-data-format module
  api( project(':modules:parquet-data-format')) {
    // JMH ships with the conflicting version 4.6. This prevents us from using jopt-simple in benchmarks (which should be ok) but allows
    // us to invoke the JMH uberjar as usual.
    exclude group: 'net.sf.jopt-simple', module: 'jopt-simple'
  }

  // JMH dependencies
  api "org.openjdk.jmh:jmh-core:$versions.jmh"
  annotationProcessor "org.openjdk.jmh:jmh-generator-annprocess:$versions.jmh"

  // Dependencies of JMH
  runtimeOnly 'net.sf.jopt-simple:jopt-simple:5.0.4'
  runtimeOnly 'org.apache.commons:commons-math3:3.6.1'

  // Arrow dependencies for test data generation (matching parent module versions)
  api "org.apache.arrow:arrow-vector:17.0.0"
  api "org.apache.arrow:arrow-memory-core:17.0.0"
  api "org.apache.arrow:arrow-memory-unsafe:17.0.0"
  api "org.apache.arrow:arrow-c-data:17.0.0"
  api "org.apache.arrow:arrow-format:17.0.0"

  // FlatBuffers dependency required by Arrow
  api "com.google.flatbuffers:flatbuffers-java:2.0.0"

  // Logging dependencies required by Arrow
  runtimeOnly "org.apache.logging.log4j:log4j-api:2.21.0"
  runtimeOnly "org.apache.logging.log4j:log4j-core:2.21.0"
  runtimeOnly "org.apache.logging.log4j:log4j-slf4j-impl:2.21.0"
}

// enable the JMH's BenchmarkProcessor to generate the final benchmark classes
// needs to be added separately otherwise Gradle will quote it and javac will fail
compileJava.options.compilerArgs.addAll(["-processor", "org.openjdk.jmh.generators.BenchmarkProcessor"])

// Disable -Werror for benchmark compilation to allow warnings
compileJava.options.compilerArgs.removeAll(['-Werror'])

// classes generated by JMH can use all sorts of forbidden APIs but we have no influence at all and cannot exclude these classes
disableTasks('forbiddenApisMain')

// No licenses for our benchmark deps (we don't ship benchmarks)
tasks.named("dependencyLicenses").configure { it.enabled = false }
dependenciesInfo.enabled = false

thirdPartyAudit.ignoreViolations(
  // these classes intentionally use JDK internal API (and this is ok since the project is maintained by Oracle employees)
  'org.openjdk.jmh.util.Utils'
)

spotless {
  java {
    // IDEs can sometimes run annotation processors that leave files in
    // here, causing Spotless to complain. Even though this path ought not
    // to exist, exclude it anyway in order to avoid spurious failures.
    targetExclude 'src/main/generated/**/*.java'
  }
}

// Add support for incubator modules and Arrow memory access on supported Java versions.
run.jvmArgs += [
  '--add-modules=jdk.incubator.vector',
  '--add-opens=java.base/java.nio=org.apache.arrow.memory.core,ALL-UNNAMED'
]

// Enable Rust backtrace for debugging native panics
run.environment += [
  'RUST_BACKTRACE': 'full'
]
